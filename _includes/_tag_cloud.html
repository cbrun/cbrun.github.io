{%- comment -%}
Tag cloud including posts and talks (non-main tags only), sorted by total count desc.
Counts exclude documents marked draft, noindex, or French translations (translation_en present).
Links point to the corresponding generated tag pages under `/tag/<slug>/`.
{%- endcomment -%}

{%- assign main_tags = site.main_categories | default: "" -%}

{%- assign posts_ok = site.posts | where_exp: 'p', "p.draft != true and p.noindex != true and p.translation_en == nil" -%}
{%- assign talks_ok = site.talks | where_exp: 't', "t.draft != true and t.noindex != true and t.translation_en == nil" -%}
{%- assign docs = posts_ok | concat: talks_ok -%}

{%- comment -%}
Collect all tag names from eligible docs, then uniquify and compute per-tag counts.
{%- endcomment -%}
{%- assign all_tag_names = '' | split: '' -%}
{%- for d in docs -%}
  {%- for tg in d.tags -%}
    {%- assign all_tag_names = all_tag_names | push: tg -%}
  {%- endfor -%}
{%- endfor -%}

{%- assign unique_tags = all_tag_names | uniq -%}
{%- assign tag_items = '' | split: '' -%}

{%- for tag_name in unique_tags -%}
  {%- assign slug = tag_name | slugify -%}
  {%- if main_tags contains slug -%}
    {%- continue -%}
  {%- endif -%}

  {%- assign docs_for_tag = docs | where_exp: 'x', "x.tags contains tag_name" -%}
  {%- assign count = docs_for_tag | size -%}
  {%- if count <= 1 -%}
    {%- continue -%}
  {%- endif -%}

  {%- comment -%}
  Resolve the tag document in the `tag` collection to get title and URL.
  Fallbacks to slug and `/tag/<slug>/` if not found.
  {%- endcomment -%}
  {%- assign tag_doc = nil -%}
  {%- assign target_url = '/tag/' | append: slug | append: '/' -%}
  {%- for d in site.tag -%}
    {%- assign dslug = nil -%}
    {%- if d.tag -%}
      {%- assign dslug = d.tag | slugify -%}
    {%- elsif d.title -%}
      {%- assign dslug = d.title | slugify -%}
    {%- endif -%}
    {%- if d.url == target_url or dslug == slug -%}
      {%- assign tag_doc = d -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if tag_doc -%}
    {%- assign label = tag_doc.title | default: tag_name -%}
    {%- assign url = tag_doc.url -%}
  {%- else -%}
    {%- assign label = tag_name -%}
    {%- assign url = target_url -%}
  {%- endif -%}

  {%- capture padded %}00000{{ count }}{%- endcapture -%}
  {%- assign padded = padded | slice: -5, 5 -%}
  {%- capture item %}{{ padded }}|{{ count }}|{{ slug }}|{{ label }}|{{ url }}{%- endcapture -%}
  {%- assign tag_items = tag_items | push: item -%}
{%- endfor -%}

{%- assign tag_items = tag_items | sort | reverse -%}
<div>
  <ul class="tag-cloud">
  {%- for entry in tag_items -%}
    {%- assign parts = entry | split: '|' -%}
    {%- assign count = parts[1] | plus: 0 -%}
    {%- assign label = parts[3] -%}
    {%- assign url = parts[4] -%}
    <li><a href="{{ site.url }}{{ url }}">{{ label }} ({{ count }})</a></li>
  {%- endfor -%}
  </ul>
  <p class="notice notice--info">Tag counts include talks.</p>
</div>
