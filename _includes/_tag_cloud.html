{%- comment -%}
Tag cloud (non-main tags only), sorted by post count desc.
Counts exclude posts marked draft, noindex, or French translations (translation_en present).
Links point to the corresponding generated tag pages under `/tag/<slug>/`.
{%- endcomment -%}

{%- assign main_tags = site.main_categories | default: "" -%}
{%- assign tag_items = '' | split: '' -%}

{%- for t in site.tags -%}
  {%- assign slug = t[0] -%}
  {%- if main_tags contains slug -%}
    {%- continue -%}
  {%- endif -%}

  {%- assign posts_all = t[1] -%}
  {%- assign posts_pub = posts_all
    | where_exp: "p", "p.draft != true"
    | where_exp: "p", "p.noindex != true"
    | where_exp: "p", "p.translation_en == nil" -%}
  {%- assign count = posts_pub | size -%}
  {%- if count == 0 -%}
    {%- continue -%}
  {%- endif -%}

  {%- comment -%}
  Resolve the tag document in the `tag` collection to get title and URL.
  Fallbacks to slug and `/tag/<slug>/` if not found.
  {%- endcomment -%}
  {%- assign tag_doc = nil -%}
  {%- assign target_url = '/tag/' | append: slug | append: '/' -%}
  {%- for d in site.tag -%}
    {%- if d.url == target_url -%}
      {%- assign tag_doc = d -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if tag_doc -%}
    {%- assign label = tag_doc.title | default: slug -%}
    {%- assign url = tag_doc.url -%}
  {%- else -%}
    {%- assign label = slug -%}
    {%- assign url = '/tag/' | append: slug | append: '/' -%}
  {%- endif -%}

  {%- comment -%}
  Build a sortable token: zero-padded count to ensure lexicographic sort works numerically.
  Store as: PADDED|COUNT|SLUG|LABEL|URL
  {%- endcomment -%}
  {%- capture padded %}00000{{ count }}{%- endcapture -%}
  {%- assign padded = padded | slice: -5, 5 -%}
  {%- capture item %}{{ padded }}|{{ count }}|{{ slug }}|{{ label }}|{{ url }}{%- endcapture -%}
  {%- assign tag_items = tag_items | push: item -%}
{%- endfor -%}

{%- assign tag_items = tag_items | sort | reverse -%}

<ul class="tag-cloud">
{%- for entry in tag_items -%}
  {%- assign parts = entry | split: '|' -%}
  {%- assign count = parts[1] | plus: 0 -%}
  {%- assign slug = parts[2] -%}
  {%- assign label = parts[3] -%}
  {%- assign url = parts[4] -%}
  <li><a href="{{ site.url }}{{ url }}">{{ label }} ({{ count }})</a></li>
{%- endfor -%}
</ul>
