{%- comment -%}
Tag cloud from posts (non-main tags only), sorted by total count desc.
Counts exclude documents marked draft, noindex, or French translations (translation_en present).
No use of where_exp to maximize Liquid 4 compatibility in includes.
{%- endcomment -%}

{%- assign main_tags = site.main_categories | default: "" -%}

{%- comment -%}
Collect all tag names from posts, then uniquify.
{%- endcomment -%}
{%- assign all_tag_names = '' | split: '' -%}
{%- for d in site.posts -%}
  {%- if d.tags -%}
    {%- for tg in d.tags -%}
      {%- assign all_tag_names = all_tag_names | push: tg -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- assign unique_tags = all_tag_names | uniq -%}
{%- assign tag_items = '' | split: '' -%}

{%- for tag_name in unique_tags -%}
  {%- assign slug = tag_name | slugify -%}
  {%- if main_tags contains slug -%}
    {%- continue -%}
  {%- endif -%}

  {%- assign count = 0 -%}
  {%- for p in site.posts -%}
    {%- if p.draft != true and p.noindex != true and p.translation_en == nil and p.tags contains tag_name -%}
      {%- assign count = count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}
  

  {%- if count <= 1 -%}
    {%- continue -%}
  {%- endif -%}

  {%- comment -%}
  Resolve the tag document in the `tag` collection to get title and URL.
  Fallbacks to slug and `/tag/<slug>/` if not found.
  {%- endcomment -%}
  {%- assign tag_doc = nil -%}
  {%- assign target_url = '/tag/' | append: slug | append: '/' -%}
  {%- for d in site.tag -%}
    {%- assign dslug = nil -%}
    {%- if d.tag -%}
      {%- assign dslug = d.tag | slugify -%}
    {%- elsif d.title -%}
      {%- assign dslug = d.title | slugify -%}
    {%- endif -%}
    {%- if d.url == target_url or dslug == slug -%}
      {%- assign tag_doc = d -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if tag_doc -%}
    {%- assign label = tag_doc.title | default: tag_name -%}
    {%- assign url = tag_doc.url -%}
  {%- else -%}
    {%- assign label = tag_name -%}
    {%- assign url = target_url -%}
  {%- endif -%}

  {%- capture padded %}00000{{ count }}{%- endcapture -%}
  {%- assign padded = padded | slice: -5, 5 -%}
  {%- capture item %}{{ padded }}|{{ count }}|{{ slug }}|{{ label }}|{{ url }}{%- endcapture -%}
  {%- assign tag_items = tag_items | push: item -%}
{%- endfor -%}

{%- assign tag_items = tag_items | sort | reverse -%}
<div>
  <ul class="tag-cloud">
  {%- for entry in tag_items -%}
    {%- assign parts = entry | split: '|' -%}
    {%- assign count = parts[1] | plus: 0 -%}
    {%- assign label = parts[3] -%}
    {%- assign url = parts[4] -%}
    <li><a href="{{ site.url }}{{ url }}">{{ label }} ({{ count }})</a></li>
  {%- endfor -%}
  </ul>
</div>
