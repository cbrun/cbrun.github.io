{%- comment -%}
Tag cloud with counts, from posts (nonâ€‘main tags only):
- Only published, indexable, English posts are considered (no draft, no noindex, no translation_en).
- Show only tags with at least 3 posts.
- Order by post count descending.
- Display label as the tag name (as used in posts), e.g., "acceleo (3)".
- Avoids where_exp for compatibility.
{%- endcomment -%}

{%- assign main_tags = site.main_categories | default: "" -%}

{%- comment -%}
Collect all tag names from qualifying posts, then dedupe to iterate once per slug.
{%- endcomment -%}
{%- assign all_tag_names = '' | split: '' -%}
{%- for p in site.posts -%}
  {%- if p.draft != true and p.noindex != true and p.translation_en == nil and p.tags -%}
    {%- for tg in p.tags -%}
      {%- assign tn = tg | strip -%}
      {%- assign all_tag_names = all_tag_names | push: tn -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}
{%- assign unique_tag_names = all_tag_names | uniq -%}

{%- assign tc_processed_slugs = '' | split: '' -%}
{%- assign tc_items = '' | split: '' -%}

{%- for tag_name in unique_tag_names -%}
  {%- assign tc_slug = tag_name | strip | slugify -%}
  {%- if main_tags contains tc_slug -%}
    {%- continue -%}
  {%- endif -%}
  {%- if tc_processed_slugs contains tc_slug -%}
    {%- continue -%}
  {%- endif -%}

  {%- comment -%}
  Count posts for this slug (case-insensitive via slugify)
  {%- endcomment -%}
  {%- assign tc_count = 0 -%}
  {%- for p in site.posts -%}
    {%- if p.draft != true and p.noindex != true and p.translation_en == nil and p.tags -%}
      {%- assign tc_has_tag = false -%}
      {%- for tg in p.tags -%}
        {%- if tc_has_tag == false and (tg | slugify) == tc_slug -%}
          {%- assign tc_has_tag = true -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if tc_has_tag -%}
        {%- assign tc_count = tc_count | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if tc_count < 3 -%}
    {%- continue -%}
  {%- endif -%}

  {%- comment -%}
  Build sortable token: zero-padded count ensures numeric sort via string sort.
  Store as: PADDED|COUNT|SLUG|LABEL
  {%- endcomment -%}
  {%- capture tc_padded %}00000{{ tc_count }}{%- endcapture -%}
  {%- assign tc_padded = tc_padded | slice: -5, 5 -%}
  {%- capture tc_item %}{{ tc_padded }}|{{ tc_count }}|{{ tc_slug }}|{{ tag_name }}{%- endcapture -%}
  {%- assign tc_items = tc_items | push: tc_item -%}
  {%- assign tc_processed_slugs = tc_processed_slugs | push: tc_slug -%}
{%- endfor -%}

{%- assign tc_items = tc_items | sort | reverse -%}

<ul class="tag-cloud">
{%- for entry in tc_items -%}
  {%- assign tc_parts = entry | split: '|' -%}
  {%- assign tc_count = tc_parts[1] | plus: 0 -%}
  {%- assign tc_slug  = tc_parts[2] -%}
  {%- assign tc_label = tc_parts[3] -%}
  <li><a href="{{ site.url }}/tag/{{ tc_slug }}/">{{ tc_label }} ({{ tc_count }})</a></li>
{%- endfor -%}
</ul>
